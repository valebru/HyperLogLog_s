# FlowFight-on-VPP
A recurring task in security monitoring / anomaly detection applications consists in finding scan-type flows, namely flows which exhibit a large cardinality in terms of number of distinct source/destination addresses, or in most generality packet-level identifiers (e.g. ports, header fields, etc). Since cardinality estimation requires to "remember" the identifiers seen in the past, this task is quite challenging when the goal is to implement per-flow distinct count at wire speed, while maintaining high processing throughput and  limited memory footprint. To address this challenge, we propose and assess an innovative design, called FlowFight. Our approach leverages HyperLogLog approximate sketches for single-flow cardinality estimation, but rather than keeping one sketch per flow, we embed them into a memory efficient data structure based on a modified version of a stream summary managed via an original randomized access policy. Using either synthetic as well as real traffic traces, we show that FlowFight is able to estimate the top-$k$ cardinality flows with an accuracy of more than 95\%, while retaining a processing throughput of around 8 Mpps on single core.

## Table of contents

   * [Requirement](#requirement)
      * [VPP configuration](#vpp-configuration)
      * [Moongen](#moongen)
      * [Synthetic Stream Generator (SSG)](#synthetic-stream-generator-ssg)
   * [Demo Setup](#demo-setup)
      * [Create synthetic trace](#create-synthetic-trace)
      * [VPP test using loopback](#vpp-test-using-loopback)
         * [VPP startup](#vpp-startup)
         * [Results processing](#results-processing)
      * [VPP test using real interface through DPDK and MoonGen](#vpp-test-using-real-interface-through-dpdk-and-moongen)
         * [VPP startup](#vpp-startup-1)
         * [MoonGen packets generation](#moongen-packets-generation)
         * [Results processing](#results-processing-1)



# Requirement

## VPP configuration

```bash
cd vpp
make bootstrap
make build-release
```

The vpp directory contains the experimental plugin in which it is implemented the FlowFight algorithm (`src/plugins/hll/`)
To download the official VPP code (without FlowFight) use the official repository `git clone https://gerrit.fd.io/r/vpp`


## [Moongen](http://scholzd.github.io/MoonGen/)

MoonGen is a high-speed scriptable packet generator. The whole load generator is controlled by a **Lua script**: all packets that are sent are crafted by a user-provided script. Thanks to the incredibly fast LuaJIT VM and the packet processing library DPDK, it can saturate a 10 GBit Ethernet link with 64 Byte packets while using only a single CPU core. MoonGen can achieve this rate even if each packet is modified by a Lua script. It does not rely on tricks like replaying the same buffer.

MoonGen can also receive packets, e.g. to check which packets are dropped by a system under test. As the reception is also fully under control of the user's Lua script, it can be used to implement advanced test scripts. E.g. one can use two instances of MoonGen that establish a connection with each other. This setup can be used to benchmark middle-boxes like firewalls.

**Installation:** [take a look to their instructions](http://scholzd.github.io/MoonGen/install.html)

**Our parser scripts:** it takes in input the TraceSet generated by ClassBench; it parses this file and it generates tables lua variables in which are stored packet fields values (one for each protocol over ipv4: TCP, UDP, ICMP). Then each table is given in input to a task that creates packets and sends them to VPP.

## Synthetic Stream Generator (SSG) 
We use the Synthetic Stream Generator (SSG) to generate a sequences of synthetic packet headers. This representation is compliant with the [Classbench](https://www.arl.wustl.edu/classbench/) format and allows to easily shape the final traffic with the desired stream distribution in terms of \{flows X distinct elements\}. For our experimental campaign, we focus on detecting the top-$k$ flows (defined by the \emph{destination\_ip}) with the largest cardinality (defined by the 5-tuple). We generate two different kind of synthetic datasets. The former is generated by shaping an uniform distribution: all the flows (10-100) have the same number of distinct elements (32k-64k); this kind of dataset has been used as a baseline to test the single component of the algorithm. The latter is generated by shaping a zipf distribution (with $\alpha=\{1.1, 1.4, 1.8\}$): these synthetic datasets likely match real pattern in realistic traces, but they are more stressful since it contains more flows and a vaster range of distinct elements with the property of not presenting duplicated elements. In both the workloads, we replicate and shuffle each dataset multiple times to test the algorithm robustness to the stream order.

[Taylor, D. E., & Turner, J. S. (2007). Classbench: A packet classification benchmark. IEEE/ACM Transactions on Networking (TON), 15(3), 499-511.](https://dl.acm.org/citation.cfm?id=1295239)


# Demo Setup
We create a script with few environment variables that refers directories and scripts of this repository. 
Therefore, to correctly use the following bash scripts and command, install these variables with this command: `source config.source`

## Create synthetic trace
Enter the SSG directory.

```bash
bash zipftrace_generation.bash
```


## VPP test using loopback
This kind of test will create an internal loopback inside VPP and can be executed without requiring particular server features.
It can be used to play and test the accuracy of the algorithm.

### VPP startup
Enter the `tools_vpp` directory.

1. Before run vpp, please check the startup.conf file in which the vpp configuration is contained. In this directory you can find a simple startup.conf that should works with our base test.
Anyway, in the startup.conf is stored information used by VPP to configure the framework, take a look to [their documentation: detailed list of options for startup-conf file](https://wiki.fd.io/view/VPP/Command-line_Arguments)

2. To launch and configure the FlowFight plugin you can run (or take a look to the command in the bash script): `sh run_vpp_ff.sh <ff_size> <hll_bits_size>`
If you want enter the vpp command line: `sudo -E $BINS/vppctl -s /run/vpp/cli.sock`

3. Finally, to generate traffic from the VPP packet generator (the synthetic stream or the real pcap): 
```
sudo -E $BINS/vppctl -s /run/vpp/cli.sock exec $FF_DIR/tools_vpp/vpp_script_2streams
sudo -E $BINS/vppctl -s /run/vpp/cli.sock exec $FF_DIR/tools_vpp/vpp_script_pcap
```

4. To extract statistics from the FF plugin: `sudo -E $BINS/vppctl -s /run/vpp/cli.sock hll count`

5. To kill VPP: `sudo killall vpp_main`


### Results processing
In the `tools_res` directory, we prepare the reference files to the two stream we generated in vpp. This files contain the exact counting of the flows cardinality. And we will use this information to compare the FlowFight estimation with the exact estimation and evaluate the precision of the top-k and the relative error of the single HLL assigned to the flow.

We also prepared two scripts in `tools_vpp` directory, that perform the complete test:
```bash
sh start_basetest.sh
sh start_basetest_pcap.sh
```

## VPP test using real interface through DPDK and MoonGen
This test will use the physical interfaces to run experiment at line speed to evaluate performance of the VPP plugin. (In particular, we will evaluate the packets per second sustained by the framework).
This test requires that your physical interfaces can be binded by DPDK. And to run the test you have to first know the pci addresses of your interfaces and bind them with dpdk. [DPDK documentation for interface binding](https://doc.dpdk.org/guides/tools/devbind.html)

                +---------------+
                |               |
        +-------+-------+       |
        |       |       |       |
        |       |       |       |
        1       0       2       3
     d8:00.1         5e:00.0
       |     d8:00.0   |    5e:00.1
        \   /		\   /
         \ /		 \ /
         VPP		MoonGen


### VPP startup
Enter the `tools_vpp` directory.

1. Before run vpp, please check the `startup_dpdk.conf` file in which the vpp configuration is contained. (You should modify this file with your pci driver) 
Anyway, in the startup.conf is stored information used by VPP to configure the framework, take a look to [their documentation: detailed list of options for startup-conf file](https://wiki.fd.io/view/VPP/Command-line_Arguments)

2. To launch and configure the FlowFight plugin you can run (or take a look to the command in the bash script): `sh run_vpp_ff_dpdk.sh <ff_size> <hll_bits_size>`
If you want enter the vpp command line: `sudo -E $BINS/vppctl -s /run/vpp/cli.sock`

3. To extract statistics from the FF plugin: `sudo -E $BINS/vppctl -s /run/vpp/cli.sock hll count`

4. To kill VPP: `sudo killall vpp_main`

### MoonGen packets generation
The `${MoonGen_dir}` is not present in the repository and refers to the MoonGen installation directory that you should have install in the requirements part. To generate packets we need interfaces not used by VPP and they must be connected in cross-connect with the ones used by VPP.
Therefore, we need to configure the dpdkfile as we do for the `startup_dpdk.conf` with the pci addresses of your interfaces.

```bash
sudo ${MoonGen_dir}/MoonGen/build/MoonGen ${MGSCR}/replay-pcap-hll.lua --dpdk-config=${dpdkfile} 0 1 ${tracefile} ${tracefile} ${tracefile} -l
```


### Results processing
In the `tools_res` directory, we prepare the reference files to the two stream we generated in vpp. This files contain the exact counting of the flows cardinality. And we will use this information to compare the FlowFight estimation with the exact estimation and evaluate the precision of the top-k and the relative error of the single HLL assigned to the flow.

We also prepared the script in `tools_vpp` directory, that performs the complete test:
```bash
sh start_dpdktest_pcap.sh
```
